include stdio h include unistd h include stdlib h include string h include fcntl h include sys types h include sys wait h char av char infile char outfile char errfile char outcmd int avsize void avreserve int n int oldavsize avsize if avsize n 1 return avsize 2 oldavsize 1 av realloc av avsize sizeof av while oldavsize avsize av oldavsize++ null void parseline char line char a int n outcmd infile outfile errfile null for n 0 n avsize n++ av n null a strtok line t r n for n 0 a n++ if a 0 infile a 1 a 1 strtok null t r n else if a 0 outfile a 1 a 1 strtok null t r n else if a 0 if a 1 outcmd strtok null else outcmd a 1 a strtok null while a outcmd && a 1 a else if a 0 2 && a 1 errfile a 2 a 2 strtok null t r n else avreserve n av n a a strtok null t r n void doexec void int fd int pipefds 2 while outcmd if outfile fprintf stderr syntax error in pipe writer n exit 1 if pipe pipefds 0 perror pipe exit 0 switch fork case 1 perror fork exit 1 case 0 if pipefds 1 1 dup2 pipefds 1 1 close pipefds 1 close pipefds 0 outcmd null break default if pipefds 0 0 dup2 pipefds 0 0 close pipefds 0 close pipefds 1 parseline outcmd if infile fprintf stderr syntax error in pipe reader n exit 1 break if infile if fd open infile o_rdonly 0 perror infile exit 1 if fd 0 dup2 fd 0 close fd if outfile if fd open outfile o_wronly o_creat o_trunc 0666 0 perror outfile exit 1 if fd 1 dup2 fd 1 close fd if errfile if fd open errfile o_wronly o_creat o_trunc 0666 0 perror errfile exit 1 if fd 2 dup2 fd 2 close fd execvp av 0 av perror av 0 exit 1 int main void char buf 512 char line int pid avreserve 10 for write 2 2 if line fgets buf sizeof buf stdin write 2 eof n 4 exit 0 parseline line if av 0 continue switch pid fork case 1 perror fork break case 0 doexec break default waitpid pid null 0 break
