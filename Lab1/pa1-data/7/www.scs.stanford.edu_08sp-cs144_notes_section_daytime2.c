cs144 simple daytime server no error checking forking threads etc author ben nham nham cs include ctype h include sys types h include sys wait h include sys socket h include netinet in h include errno h include stdio h include stdlib h include unistd h include string h include netdb h include signal h include string h include time h define backlog 20 not used in this example but can be useful for simulating try finally type constructs see the cs244a coding guidelines page linked to from the assignment webpage for example usage here is an example usage of this macro print_err listen socketfd backlog 1 cleanup listen define print_err expr label prefix if expr perror prefix goto label when the client connects sends the current day and time in the response void do_server uint16_t port int sd clisd struct sockaddr_in srv cli u_int clisize sizeof cli memset &srv 0 sizeof srv srv sin_family af_inet srv sin_port htons port srv sin_addr s_addr inaddr_any sd socket af_inet sock_stream 0 bind sd struct sockaddr &srv sizeof srv listen sd backlog while clisd accept sd struct sockaddr &cli &clisize 1 if fork 0 for demonstration purposes fprintf stderr i m the child with pid d n getpid child doesn t need to use sd close sd time_t curtime time null char timestr ctime &curtime send clisd timestr strlen timestr 0 this is the same as a two way shutdown close clisd exit 0 else parent doesn t need to use clisd close clisd close sd wait on forked processes when we get a sichld until there's nothing left to wait on void sigchld_handler int s while waitpid 1 null wnohang 0 int main int argc char argv int port 0 if argc 2 argc 2 && port atoi argv 1 0 port 65536 fprintf stderr usage s port n argv 0 exit 1 install signal handler to reap all dead processes struct sigaction sa sa sa_handler sigchld_handler sigemptyset &sa sa_mask sa sa_flags sa_restart if sigaction sigchld &sa null 1 perror sigaction exit 1 do_server uint16_t port
