usr bin perl copyright 2003 bryan ford distributed under the gnu general public license usage mergedep main depfile new depfiles this script merges the contents of all new depfiles specified on the command line into the single file main depfile which may or may not previously exist dependencies in the new depfiles will override any existing dependencies for the same targets in main depfile the new depfiles are deleted after main depfile is updated the new depfiles are typically generated by gcc with the md option and the main depfile is typically included from a makefile as shown here for gnu make deps wildcard d perl mergedep include deps this script properly handles multiple dependencies per new depfile including dependencies having no target so it is compatible with gcc3's mp option sub readdeps my filename shift open depfile filename or return 0 while depfile if my target $1 my deplines $2 my slash $3 while slash ne _ depfile defined _ or die unterminated dependency in filename t or die bad continuation line in filename deplines deplines n $1 slash $2 print dependency target deplines n dephash target deplines elsif t ignore blank lines and comments else die bad dependency line in filename _ close depfile return 1 if argv 0 print usage mergedep main depfile new depfiles n exit 1 dephash read the main dependency file maindeps argv 0 readdeps maindeps read and merge in the new dependency files foreach i 1 argv readdeps argv i or die can t open argv i update the main dependency file open depfile maindeps tmp or die can t open output file maindeps tmp foreach target keys dephash print depfile target dephash target close depfile rename maindeps tmp maindeps or die can t overwrite maindeps finally delete the new dependency files foreach i 1 argv unlink argv i or print error removing argv i n
