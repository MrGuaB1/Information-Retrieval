include p30f4013 h include timer h define num_of_per_sec 60 1 sec 4 120mhz 8 2 16 60 define boat_idle_sec 3 set boat to idle stop state if 3 sec pass without any rx from helm void __attribute__ __interrupt__ _t3interrupt void normal timer static unsigned long numtimer3overflow numseconds static unsigned char timeupflag standardtimer boat idle timer static unsigned long numboatidleoverflow boatidleflag void inittimer3 void t3conbits tcs 0 internal clock source t3conbits tgate 0 gated time accumulation disabled t3conbits tckps 0b01 1 8 prescale value t3conbits tsidl 0 continue timer operation in idle mode t3conbits ton 0 turn off tmr3 tmr3 0 reset clear tmr3 pr3 0xffff set pr3 to basically check for overflow timeupflag 0 numtimer3overflow 0 initialize overflow counter numboatidleoverflow 0 boatidleflag 0 standardtimer 0 disable standard timer t3conbits ton 1 turn on tmr3 ipc1bits t3ip 5 set to lower priority ifs0bits t3if 0 clear tmr3ir flag iec0bits t3ie 1 enable tmr3 interrupts unsigned char timer3isup void return timeupflag void settimer3 unsigned char seconds numtimer3overflow 0 numseconds seconds timeupflag 0 ifs0bits t3if 0 clear tmr3 interruptflag standardtimer 1 enable standard timer void resetboatidletimer void numboatidleoverflow 0 boatidleflag 0 unsigned char boatisidle void return boatidleflag void __attribute__ __interrupt__ _t3interrupt void ifs0bits t3if 0 clear tmr3 interruptflag numtimer3overflow++ increment overflows if numtimer3overflow num_of_per_sec numseconds && standardtimer 1 numtimer3overflow 0 timeupflag 1 standardtimer 0 disable standard timer numboatidleoverflow++ if numboatidleoverflow num_of_per_sec boat_idle_sec numboatidleoverflow 0 boatidleflag 1
