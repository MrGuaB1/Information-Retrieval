km h copyright c 2001 matt pharr mmp at exluna dot com this software is placed in the public domain and is provided as is without express or implied warranty basic implementation of the kubelka munk model for the composition of layered surfaces see siggraph 2001 course notes advanced renderman 3 render harder for notes and background information void sinhcosh float t output float sinh cosh if t 10 t 10 float ex exp t float invex 1 ex sinh 0.5 ex invex cosh 0.5 ex invex void kmestimatecoeffs color rinf output color sigma_a sigma_s if rinf color 0 sigma_a color 1 sigma_s color 0 else color a_over_s 1 rinf 1 rinf 2 rinf sigma_a color 1 sigma_s sigma_a a_over_s void km color sigma_a sigma_s float thickness output color r t float i for i 0 i ncomps i 1 float s comp sigma_s i a comp sigma_a i float aa s a s float b sqrt max aa aa 1 0 float sh ch sinhcosh b s thickness sh ch setcomp r i sh aa sh b ch setcomp t i b aa sh b ch color kminfinite color sigma_a sigma_s float i color r 0 for i 0 i ncomps i 1 float a comp sigma_a i comp sigma_s i float r 1 a sqrt a a 2 a setcomp r i r return r color kmcomposer color r1 t1 r2 t2 return r1 t1 r2 t1 color 1 r1 r2 color kmcomposet color r1 t1 r2 t2 return t1 t2 color 1 r1 r2 color kmoverglossy normal nf color sigma_a sigma_s kd ks float thickness roughness color r1 t1 km sigma_a sigma_s thickness r1 t1 color kdnew kmcomposer r1 t1 kd color 0 color ksnew kmcomposer 0 t1 ks color 0 float ksratio comp ks 0 comp ksnew 0 float roughnew roughness ksratio extern vector i return kdnew diffuse nf ksnew specular nf normalize i roughnew
