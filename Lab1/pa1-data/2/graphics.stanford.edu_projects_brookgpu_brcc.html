brookgpu brcc architecture brookgpu brcc architecture home introduction forums getting started language architecture brcc brt brt c++ current issues research sponsors brcc is a source to source compiler that takes in brook br files and produces c++ files that can then be fed through a standard c++ compiler brcc flow brcc runs in three distinct stages first it parses the input file into a transunit then it runs a few passes over the transunit identifying brook specific pieces and converting them into brt brook run time specialized types finally it traverses the transunit printing each node the untransformed units reproduce their original contents and the brt units emit c++ code to execute the brook operations call into the brt for the run time determined portions note that a number of operations eg compiling cg hlsl to fragment assembly are deferred until the print phase since they are really only needed for emitting the code not representing it brcc organization brcc is built upon an open source project named ctool http ctool sourceforge net ctool is a c++ program that takes c as its input and builds a transunit that reflects its parsed form it also knows how to traverse the parsed content and print it out again the key files from ctool are gram y the bison grammar for the parser it's fairly sophisticated ctool recognizes pretty much all of c and a number of gcc extensions decl cpp h class definitions enums and implementations for all of the objects that represent c declarations in the parse tree eg structdef basetype etc express cpp h class definitions and implementations for all of the objects that represent c expressions in the parse tree eg binaryexpr functioncall etc stemnt cpp h class definitions and implementations for all of the objects that represent c statements or collections of statements in the parse tree eg functiondef block ifstemnt etc there are a number of other files from ctool that are part of the support but those above are the heart of parsing and representing c and brook the ctool files can all be recognized by their copyright at the top the second major class of files are those reflecting the various brt classes after parsing using the ctool files brcc traverses the tree and converts objects representing special brook constructs into brook specialized objects the key files here are brtdecl cpp h a specialization of decl cpp h that is used for the brtstream type declarations of streams outside of kernel functions brtexpress cpp h a specialization of express cpp h that is used for the brtstreaminitializer type initializer expressions given at stream declaration time brtstemnt cpp h a specialization of stemnt cpp h that is used for brtkerneldef and its subclasses one for cpu hosted kernels and one for gpu brcc converts functiondefs that represent kernels into one of these types the third major class of files are files that provide helper functionality to the brt files their separation from the brt files is largely an artifact of history their development and they should be folded into the appropriate brt files over time codegen cpp h takes a kernel's prototype and body and produces prototypes and a wrapper function to invoke the kernel from c and runs the kernel contents through a cg hlsl compiler annotates the output and provides it as a const char in the output file brook2cpp cpp h for cpu hosted kernels brook2cpp converts the cg hlsl contents of the kernel into corresponding c++ what changes go where thus far all of the changes that happen at parse time eg handling floatn constructors recognizing kernel etc have happened within the ctool files themselves clearly for changes to the grammar this is unavoidable but brcc has also followed ctool's trend of putting all the decls in decl all the expressions in express etc so the parse time representation of a stream is handled in decl floatn constructors are in express etc all the changes connected to supporting the second phase and then printing of brt types have gone in files named brt brt expressions are in brtexpress etc this has been sufficient so far but certain functionality eg brtcpukerneldef might grow enough in complexity to deserve its own file in those cases new files that contain brt types should logically enough still have a brt prefix in their names there are a few other stray files such as main and subprocess they offer generic functionality not associated with any ctool classes or brt classes and creating new helper files to stash general functionality helps reduce the clutter in ctool brt files and encapsulate functionality appendix differences from c notation for declaring and denoting streams kernel reduce iter indexof keyword kernel bodies only support as much of c c++ as cg hlsl supports float2 float3 float4 available as types sourceforge net logo the fly fishing flies featured on this web site can be purchased at the english fly fishing shop
